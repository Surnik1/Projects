import telebot
import requests
from telebot import types
tg_bot_key = 'Bot_Father_token'
exchanger_key = 'Token_https://www.exchangerate-api.com/'

bot = telebot.TeleBot(tg_bot_key)


def get_exchange(base, target):
    url = f'https://v6.exchangerate-api.com/v6/{exchanger_key}/latest/{base}'
    response = requests.get(url)
    data = response.json()

    if data.get('result') != 'success':
        return None

    rates = data.get('conversion_rates', {})
    return rates.get(target)


@bot.message_handler(commands=['start'])
def start(message):
    kb = types.ReplyKeyboardMarkup(resize_keyboard=True)
    btn1 = types.KeyboardButton('100 USD KZT')
    btn2 = types.KeyboardButton('100 USD EUR')
    btn3 = types.KeyboardButton('100 EUR KZT')
    kb.row(btn1)
    kb.row(btn2)
    kb.row(btn3)
    bot.send_message(message.chat.id,        
        "üëã Hi! I am a currency exchanger üí±\n\n"
        "You can:\n"
        "‚Ä¢ Use buttons below\n"
        "‚Ä¢ Or write: `100 USD KZT`\n"
        "‚Ä¢ Or just: `USD KZT`",
        reply_markup=kb)
def help_cmd(message):
    kb = types.ReplyKeyboardMarkup(resize_keyboard=True)
    btn1 = types.KeyboardButton('100 USD KZT')
    btn2 = types.KeyboardButton('100 USD EUR')
    btn3 = types.KeyboardButton('100 EUR KZT')
    kb.row(btn1)
    kb.row(btn2)
    kb.row(btn3)
    bot.send_message(
        message.chat.id,
        "*How to use this bot*\n\n"
        "‚úÖ Format:\n"
        "`100 USD KZT`\n\n"
        "‚úÖ Without amount (default = 1):\n"
        "`USD KZT`\n\n"
        "‚úÖ Or use buttons under your keyboard üëá",
        reply_markup=kb
    )
    

@bot.message_handler(content_types=['text'])
def convert(message):
    try:
        txt = message.text.upper().split()

        if len(txt) == 2:
            amount = 1
            base, target = txt

        # 100 USD KZT
        elif len(txt) == 3:
            amount = float(txt[0])
            base, target = txt[1], txt[2]

        else:
            raise ValueError

        rate = get_exchange(base, target)
        if not rate:
            raise ValueError

        result = amount * rate
        bot.send_message(
            message.chat.id,
            f"{amount} {base} = {result:.2f} {target}"
        )

    except:
        bot.send_message(
            message.chat.id,
            "‚ùå Wrong format\nExample:\n100 USD KZT\nUSD KZT"
        )

    
bot.infinity_polling()
